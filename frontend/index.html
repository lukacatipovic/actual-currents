<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actual Currents - Tidal Flow Visualization</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0e27;
            color: #e0e6ed;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* Side Panel */
        #sidePanel {
            position: absolute;
            top: 0;
            left: 0;
            width: 340px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1f3a 0%, #0f1429 100%);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        #sidePanel.collapsed {
            transform: translateX(-340px);
        }

        #togglePanel {
            position: absolute;
            top: 20px;
            left: 350px;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #sidePanel.collapsed + #togglePanel {
            left: 10px;
            border-radius: 8px;
        }

        #togglePanel:hover {
            transform: scale(1.05);
            box-shadow: 2px 2px 15px rgba(102, 126, 234, 0.4);
        }

        #togglePanel svg {
            width: 20px;
            height: 20px;
            fill: white;
            transition: transform 0.3s;
        }

        #sidePanel.collapsed + #togglePanel svg {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 25px;
        }

        .panel-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .panel-header p {
            margin: 8px 0 0 0;
            font-size: 13px;
            color: #8892b0;
        }

        .section {
            margin-bottom: 28px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #8892b0;
            margin-bottom: 12px;
        }

        /* Time Controls */
        #currentTime {
            font-size: 13px;
            color: #64ffda;
            margin-bottom: 12px;
            padding: 10px;
            background: rgba(100, 255, 218, 0.05);
            border-radius: 6px;
            border-left: 3px solid #64ffda;
        }

        .time-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .time-controls input {
            flex: 1;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e0e6ed;
            font-size: 13px;
            transition: all 0.2s;
        }

        .time-controls input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }

        .time-btn {
            width: 42px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e0e6ed;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .time-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #667eea;
        }

        button {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Basemap Selector */
        .basemap-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .basemap-option {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            transition: all 0.2s;
        }

        .basemap-option:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .basemap-option.active {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            color: #64ffda;
        }

        /* Animation Type Selector */
        .animation-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .animation-option {
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .animation-option:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .animation-option.active {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .animation-option-title {
            font-weight: 600;
            font-size: 13px;
            color: #e0e6ed;
            margin-bottom: 4px;
        }

        .animation-option.active .animation-option-title {
            color: #64ffda;
        }

        .animation-option-desc {
            font-size: 11px;
            color: #8892b0;
            line-height: 1.4;
        }

        /* Status */
        #status {
            font-size: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-top: 12px;
            text-align: center;
        }

        .loading {
            color: #64ffda;
        }

        .error {
            color: #ff6b6b;
        }

        .success {
            color: #51cf66;
        }

        /* Time Slider */
        #timeSlider {
            position: absolute;
            bottom: 60px;
            left: 360px;
            right: 20px;
            height: 40px;
            z-index: 1;
            display: flex;
            align-items: center;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #sidePanel.collapsed ~ #timeSlider {
            left: 20px;
        }

        .slider-container {
            flex: 1;
            position: relative;
            height: 40px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        #timeRange {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            outline: none;
            cursor: pointer;
            z-index: 2;
        }

        #timeRange::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 3px;
            height: 40px;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.8), 0 0 20px rgba(102, 126, 234, 0.4);
            border-radius: 2px;
        }

        #timeRange::-webkit-slider-thumb:hover {
            background: #764ba2;
            box-shadow: 0 0 15px rgba(118, 75, 162, 0.9), 0 0 30px rgba(118, 75, 162, 0.5);
        }

        #timeRange::-moz-range-thumb {
            width: 3px;
            height: 40px;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.8), 0 0 20px rgba(102, 126, 234, 0.4);
            border-radius: 2px;
        }

        #timeRange::-moz-range-thumb:hover {
            background: #764ba2;
            box-shadow: 0 0 15px rgba(118, 75, 162, 0.9), 0 0 30px rgba(118, 75, 162, 0.5);
        }

        .slider-day-labels {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            pointer-events: none;
            z-index: 1;
        }

        .day-label {
            font-size: 14px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            letter-spacing: 0.5px;
        }

        /* Legend */
        #legend {
            position: absolute;
            bottom: 20px;
            left: 360px;
            right: 20px;
            height: 30px;
            z-index: 1;
            display: flex;
            align-items: center;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #sidePanel.collapsed ~ #legend {
            left: 20px;
        }

        .gradient-bar {
            flex: 1;
            height: 30px;
            background: linear-gradient(to right, 
                #0000ff 0%, 
                #0080ff 25%, 
                #00ff00 40%, 
                #80ff00 55%, 
                #ffff00 70%, 
                #ff8000 85%, 
                #ff0000 100%);
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .gradient-labels {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            pointer-events: none;
        }

        .legend-label {
            position: absolute;
            right: -50px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            font-weight: 600;
            color: #e0e6ed;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Scrollbar Styling */
        #sidePanel::-webkit-scrollbar {
            width: 8px;
        }

        #sidePanel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        #sidePanel::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 4px;
        }

        #sidePanel::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Side Panel -->
    <div id="sidePanel">
        <div class="panel-content">
            <div class="panel-header">
                <h1>Actual Currents</h1>
                <p>Real-time tidal flow visualization</p>
            </div>

            <!-- Time Controls Section -->
            <div class="section">
                <div class="section-title">Time Control</div>
                <div id="currentTime">Current time: --</div>
                <div class="time-controls">
                    <button class="time-btn" id="prevBtn">-1h</button>
                    <input type="datetime-local" id="timeInput" />
                    <button class="time-btn" id="nextBtn">+1h</button>
                </div>
                <button id="nowBtn">Jump to Now</button>
            </div>

            <!-- Basemap Selection Section -->
            <div class="section">
                <div class="section-title">Basemap Style</div>
                <div class="basemap-grid">
                    <div class="basemap-option" data-style="mapbox://styles/mapbox/dark-v11">
                        Dark
                    </div>
                    <div class="basemap-option" data-style="mapbox://styles/mapbox/satellite-v9">
                        Satellite
                    </div>
                    <div class="basemap-option active" data-style="mapbox://styles/mapbox/navigation-night-v1">
                        Navigation
                    </div>
                    <div class="basemap-option" data-style="mapbox://styles/mapbox/light-v11">
                        Light
                    </div>
                </div>
            </div>

            <!-- Animation Type Section -->
            <div class="section">
                <div class="section-title">Visualization Mode</div>
                <div class="animation-options">
                    <div class="animation-option active" data-mode="colored-particles">
                        <div class="animation-option-title">Colored Particles</div>
                        <div class="animation-option-desc">Particles change color based on current velocity</div>
                    </div>
                    <div class="animation-option" data-mode="white-particles">
                        <div class="animation-option-title">White Particles</div>
                        <div class="animation-option-desc">Simple white particle trails</div>
                    </div>
                    <div class="animation-option" data-mode="vector-arrows">
                        <div class="animation-option-title">Vector Arrows</div>
                        <div class="animation-option-desc">Static arrows showing current direction and magnitude</div>
                    </div>
                </div>
            </div>

            <!-- Animation Control -->
            <div class="section">
                <button id="animateBtn" style="background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);">
                    Start Animation
                </button>
                <div id="status">Ready</div>
            </div>
        </div>
    </div>

    <!-- Toggle Button -->
    <button id="togglePanel" aria-label="Toggle side panel">
        <svg viewBox="0 0 24 24">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </svg>
    </button>

    <!-- Time Slider -->
    <div id="timeSlider">
        <div class="slider-container">
            <input type="range" id="timeRange" min="0" max="336" value="0" step="1">
            <div class="slider-day-labels" id="dayLabels">
                <!-- Day labels will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div id="legend">
        <div class="gradient-bar">
            <div class="gradient-labels">
                <span>0</span>
                <span>0.58</span>
                <span>1.17</span>
                <span>1.94</span>
                <span>2.33</span>
            </div>
            <div class="legend-label">knots</div>
        </div>
    </div>

    <script src="js/particles.js"></script>
    <script>
        // Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoibHVrYWNhdGlwb3ZpYyIsImEiOiJjbWtoZHZxa2wwamR6M2Nvb3Y5cGJubTQwIn0.iuVLjdpQvRkHoxPV9IsUvg';

        // Initialize map centered on Western North Atlantic
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/navigation-night-v1',
            center: [-70.685, 41.518382],
            zoom: 13,
            pitch: 0
        });

        // API endpoint
        const API_BASE = 'http://localhost:8000/api/v1';

        // Data storage
        let meshData = null;
        let particleSystem = null;
        let currentTime = new Date();
        let baseTime = new Date(); // Reference time for the slider (start of 2-week range)
        let currentAnimationMode = 'colored-particles';

        // Initialize base time to current time (slider starts at 0 = now)
        baseTime = new Date(currentTime);

        // Auto-load configuration
        const MIN_ZOOM_FOR_DATA = 8;
        let loadDebounceTimer = null;
        let currentAbortController = null;

        // Generate day of week labels for the slider
        function generateDayLabels() {
            const dayLabelsContainer = document.getElementById('dayLabels');
            const daysOfWeek = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            
            // Generate labels for 14 days (2 weeks)
            for (let i = 0; i <= 14; i++) {
                const date = new Date(baseTime.getTime() + i * 24 * 60 * 60 * 1000);
                const dayIndex = date.getDay();
                const label = document.createElement('span');
                label.className = 'day-label';
                label.textContent = daysOfWeek[dayIndex];
                dayLabelsContainer.appendChild(label);
            }
        }

        // Initialize day labels on load
        generateDayLabels();

        // Status helpers
        const status = document.getElementById('status');
        function setStatus(msg, type = '') {
            status.textContent = msg;
            status.className = type;
        }

        // Time helpers
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function updateTimeDisplay() {
            const timeStr = currentTime.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            });
            document.getElementById('currentTime').textContent = `Current time: ${timeStr}`;
            document.getElementById('timeInput').value = formatDateTimeLocal(currentTime);
        }

        // Initialize time
        updateTimeDisplay();

        // Schedule a debounced data load
        function scheduleLoad() {
            clearTimeout(loadDebounceTimer);

            if (map.getZoom() < MIN_ZOOM_FOR_DATA) {
                if (currentAbortController) {
                    currentAbortController.abort();
                }
                clearMesh();
                setStatus(`Zoom in to see tidal currents (zoom ${Math.floor(map.getZoom())}/${MIN_ZOOM_FOR_DATA}+)`, '');
                return;
            }

            setStatus('Loading...', 'loading');
            loadDebounceTimer = setTimeout(loadMeshData, 100);
        }

        // Clear mesh data from map
        function clearMesh() {
            if (particleSystem) {
                particleSystem.destroy();
                particleSystem = null;
                const btn = document.getElementById('animateBtn');
                btn.textContent = 'Start Animation';
                btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
            meshData = null;
        }

        // Load mesh data from API
        async function loadMeshData() {
            if (currentAbortController) {
                currentAbortController.abort();
            }
            currentAbortController = new AbortController();

            const bounds = map.getBounds();
            const minLat = bounds.getSouth();
            const maxLat = bounds.getNorth();
            const minLon = bounds.getWest();
            const maxLon = bounds.getEast();

            try {
                const timeStr = currentTime.toISOString();
                const url = `${API_BASE}/mesh?min_lat=${minLat}&max_lat=${maxLat}&min_lon=${minLon}&max_lon=${maxLon}&time=${timeStr}`;

                console.log('Fetching:', url);
                const response = await fetch(url, { signal: currentAbortController.signal });

                if (!response.ok) {
                    const text = await response.text();
                    if (response.status === 400 && text.includes('Too many nodes')) {
                        setStatus('Too many nodes - zoom in more', '');
                        return;
                    }
                    if (response.status === 404) {
                        clearMesh();
                        setStatus('No tidal data in this area', '');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }

                meshData = await response.json();
                visualizeMesh();

            } catch (error) {
                if (error.name === 'AbortError') return;
                setStatus(`Error: ${error.message}`, 'error');
                console.error('Failed to load mesh:', error);
            }
        }

        // Visualize mesh
        function visualizeMesh() {
            if (!meshData) return;

            const { lat, lon, u_velocity, v_velocity, depth } = meshData.nodes;
            const n = lat.length;
            
            // Create point features for reference only
            const features = new Array(n);
            
            for (let i = 0; i < n; i++) {
                const u = u_velocity[i];
                const v = v_velocity[i];
                const magnitude = Math.sqrt(u * u + v * v);
                
                features[i] = {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [lon[i], lat[i]] },
                    properties: {
                        magnitude: magnitude,
                        u_vel: u,
                        v_vel: v,
                        depth: depth ? depth[i] : 0
                    }
                };
            }

            const magnitudes = features.map(f => f.properties.magnitude);
            const maxMag = Math.max(...magnitudes);
            const avgMag = magnitudes.reduce((a, b) => a + b, 0) / magnitudes.length;

            setStatus(
                `${features.length.toLocaleString()} nodes | ` +
                `Avg: ${avgMag.toFixed(3)} m/s | Max: ${maxMag.toFixed(3)} m/s`,
                'success'
            );

            if (!particleSystem) {
                const particleOptions = {
                    numParticles: 5000,
                    speedScale: 2,
                    maxAge: 150,
                    trailFade: 0.95,
                    lineWidth: 1.5,
                    colorMode: currentAnimationMode
                };

                particleSystem = new ParticleSystem(map, meshData, particleOptions);
                
                // Only start animation for particle modes
                if (currentAnimationMode !== 'vector-arrows') {
                    particleSystem.start();
                    const btn = document.getElementById('animateBtn');
                    btn.textContent = 'Stop Animation';
                    btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';
                } else {
                    // For vector arrows, just render once
                    particleSystem.renderVectorField();
                }
            } else {
                particleSystem.updateMeshData(meshData);
            }
        }

        // Time control functions
        function adjustTime(hours) {
            currentTime = new Date(currentTime.getTime() + hours * 60 * 60 * 1000);
            updateTimeDisplay();
            updateSliderFromTime();
            scheduleLoad();
        }

        function jumpToNow() {
            currentTime = new Date();
            baseTime = new Date();
            updateTimeDisplay();
            document.getElementById('timeRange').value = 0; // Start at now
            
            // Regenerate day labels from new base time
            const dayLabelsContainer = document.getElementById('dayLabels');
            dayLabelsContainer.innerHTML = '';
            generateDayLabels();
            
            scheduleLoad();
        }

        function handleTimeInputChange(e) {
            const newTime = new Date(e.target.value);
            if (!isNaN(newTime.getTime())) {
                currentTime = newTime;
                updateTimeDisplay();
                updateSliderFromTime();
                scheduleLoad();
            }
        }

        function updateSliderFromTime() {
            const diffMs = currentTime - baseTime;
            const diffHours = Math.round(diffMs / (1000 * 60 * 60));
            document.getElementById('timeRange').value = Math.max(0, Math.min(336, diffHours));
        }

        // Time slider handler
        document.getElementById('timeRange').addEventListener('input', function(e) {
            const hoursFromBase = parseInt(e.target.value);
            currentTime = new Date(baseTime.getTime() + hoursFromBase * 60 * 60 * 1000);
            updateTimeDisplay();
            scheduleLoad();
        });

        // Toggle particle animation
        function toggleAnimation() {
            if (!particleSystem) return;
            
            // Vector arrows mode doesn't animate
            if (currentAnimationMode === 'vector-arrows') {
                return;
            }
            
            const running = particleSystem.toggle();
            const btn = document.getElementById('animateBtn');
            btn.textContent = running ? 'Stop Animation' : 'Start Animation';
            btn.style.background = running 
                ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)' 
                : 'linear-gradient(135deg, #51cf66 0%, #37b24d 100%)';
        }

        // Panel toggle
        document.getElementById('togglePanel').addEventListener('click', () => {
            document.getElementById('sidePanel').classList.toggle('collapsed');
        });

        // Time controls
        document.getElementById('prevBtn').addEventListener('click', () => adjustTime(-1));
        document.getElementById('nextBtn').addEventListener('click', () => adjustTime(1));
        document.getElementById('nowBtn').addEventListener('click', jumpToNow);
        document.getElementById('timeInput').addEventListener('change', handleTimeInputChange);
        document.getElementById('animateBtn').addEventListener('click', toggleAnimation);

        // Basemap selection
        document.querySelectorAll('.basemap-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.basemap-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
                map.setStyle(this.dataset.style);
            });
        });

        // Animation mode selection
        document.querySelectorAll('.animation-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.animation-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
                const newMode = this.dataset.mode;
                const oldMode = currentAnimationMode;
                currentAnimationMode = newMode;
                
                // Update particle system
                if (particleSystem) {
                    particleSystem.setColorMode(currentAnimationMode);
                    
                    // Handle transition between modes
                    if (newMode === 'vector-arrows') {
                        // Stop animation and render static vectors
                        particleSystem.stop();
                        particleSystem.renderVectorField();
                        
                        const btn = document.getElementById('animateBtn');
                        btn.textContent = 'Vector Mode';
                        btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        btn.disabled = true;
                    } else if (oldMode === 'vector-arrows') {
                        // Start animation when switching from vectors
                        particleSystem.start();
                        
                        const btn = document.getElementById('animateBtn');
                        btn.textContent = 'Stop Animation';
                        btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';
                        btn.disabled = false;
                    }
                }
            });
        });

        // Auto-load on pan/zoom
        map.on('moveend', scheduleLoad);

        // Auto-load on initial map load
        map.on('load', () => {
            map.addSource('gebco-bathymetry', {
                type: 'raster',
                tiles: ['https://tiles.gebco.net/tiles/gebco_2023/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: 'Â© GEBCO'
            });

            map.addLayer({
                id: 'gebco-bathymetry-layer',
                type: 'raster',
                source: 'gebco-bathymetry',
                paint: {
                    'raster-opacity': 0.6
                }
            });

            scheduleLoad();
        });

        console.log('Actual Currents Visualization initialized');
    </script>
</body>
</html>